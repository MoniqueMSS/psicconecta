{% extends 'base.html' %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="text-center">
    <h1 class="mb-4">Bem-vindo, {{ user.username }}!</h1>
    <p class="mb-4">Este é seu painel de controle.</p>

    <div class="d-grid gap-3 col-6 mx-auto mb-5">
        <a href="{% url 'srq20' %}" class="btn btn-primary btn-lg">Responder Questionário SRQ-20</a>
        <a href="{% url 'resultado' %}" class="btn btn-secondary btn-lg">Ver Resultado</a>
        <a href="{% url 'logout' %}" class="btn btn-danger btn-lg">Sair</a>
    </div>

    <hr>

    <h2 class="mt-5">Seus Dados</h2>
    <p><strong>Pontuação:</strong> {{ pontuacao|default:"Sem dados" }}</p>
    <p><strong>Classificação:</strong> {{ classificacao }}</p>

    <h2 class="mt-5">Métricas Gerais</h2>
    <p><strong>Média Geral:</strong> {{ media_geral }}</p>
    <p><strong>% com transtornos moderados/graves:</strong> {{ percentual_transtorno }}%</p>

    <div class="chart-container">
        <canvas id="graficoSRQ" width="400" height="200" class="mt-4"></canvas>
    </div>

    <h2 class="mt-5">Distribuição de Respostas por Pergunta</h2>
    <div class="chart-container">
        <canvas id="respostaDistribuicaoChart" width="400" height="300"></canvas>
    </div>

    <h2 class="mt-5">Histórico de Respostas</h2>
    {% if historico %}
        <div class="table-responsive">
            <table class="table table-striped table-bordered">
                <thead>
                    <tr>
                        <th>Data/Hora</th>
                        <th>Questão</th>
                        <th>Resposta</th>
                    </tr>
                </thead>
                <tbody>
                    {% for resposta in historico %}
                    <tr>
                        <td>{{ resposta.created_at }}</td>
                        <td>{{ resposta.question.texto }}</td>
                        <td>{% if resposta.resposta %}Sim{% else %}Não{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    {% else %}
        <p>Nenhum histórico de respostas encontrado.</p>
    {% endif %}

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
const ctx = document.getElementById('graficoSRQ').getContext('2d');
const chart = new Chart(ctx, {
    type: 'bar',
    data: {
        labels: ['Você', 'Média Geral'],
        datasets: [{
            label: 'Pontuação SRQ-20',
            data: [{{ pontuacao|default:0 }}, {{ media_geral|default:0 }}],
            backgroundColor: ['#4dd0e1', '#f48fb1'],
            borderRadius: 8
        }]
    },
    options: {
        responsive: true,
        scales: {
            y: {
                beginAtZero: true,
                max: 20
            }
        }
    }
});
</script>

<script>
const respostaDistribuicaoData = {{ resposta_distribuicao|safe }};  // Get data from context
const labels = respostaDistribuicaoData.map(item => item.pergunta);
const simData = respostaDistribuicaoData.map(item => item.sim);
const naoData = respostaDistribuicaoData.map(item => item.nao);

const ctxResposta = document.getElementById('respostaDistribuicaoChart').getContext('2d');
const respostaDistribuicaoChart = new Chart(ctxResposta, {
    type: 'bar',
    data: {
        labels: labels,
        datasets: [{
            label: 'Sim',
            data: simData,
            backgroundColor: '#4caf50', // Green for Sim
        }, {
            label: 'Não',
            data: naoData,
            backgroundColor: '#f44336', // Red for Nao
        }]
    },
    options: {
        responsive: true,
        scales: {
            x: {
                stacked: true,
                ticks: {
                    display: false // Hide x-axis labels (questions) if too many
                }
            },
            y: {
                stacked: true,
                beginAtZero: true
            }
        }
    });
</script>
{% endblock %}